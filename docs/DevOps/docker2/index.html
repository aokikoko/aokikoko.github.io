<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.14">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Aoki 的自留地 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Aoki 的自留地 Atom Feed">
<link rel="search" type="application/opensearchdescription+xml" title="Aoki 的自留地" href="/opensearch.xml"><title data-react-helmet="true">[DevOps] 容器技术管理工具-Docker(中) | Aoki 的自留地</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://phero.live/docs/DevOps/docker2"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="current"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="[DevOps] 容器技术管理工具-Docker(中) | Aoki 的自留地"><meta data-react-helmet="true" name="description" content="docker 镜像"><meta data-react-helmet="true" property="og:description" content="docker 镜像"><link data-react-helmet="true" rel="icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://phero.live/docs/DevOps/docker2"><link data-react-helmet="true" rel="alternate" href="https://phero.live/docs/DevOps/docker2" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://phero.live/docs/DevOps/docker2" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BMRZNSN9O0-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.b35462c9.css">
<link rel="preload" href="/assets/js/runtime~main.84ec8b59.js" as="script">
<link rel="preload" href="/assets/js/main.b4022aec.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top navbar--dark"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_TMUO themedImage--light_4Vu1"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_TMUO themedImage--dark_uzRr"></div><b class="navbar__title">Aoki</b></a><a class="navbar__item navbar__link navbar__link--active" href="/docs/intro">笔记</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/aokikoko" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_iYfV toggle_2i4l toggleDisabled_xj38"><div class="toggleTrack_t-f2" role="button" tabindex="-1"><div class="toggleTrackCheck_mk7D"><span class="toggleIcon_pHJ9">🌜</span></div><div class="toggleTrackX_dm8H"><span class="toggleIcon_pHJ9">🌞</span></div><div class="toggleTrackThumb_W6To"></div></div><input type="checkbox" class="toggleScreenReader_h9qa" aria-label="Switch between dark and light mode"></div><div class="searchBox_Utm0"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_lDyR"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_i9tI" type="button"></button><aside class="docSidebarContainer_0YBq"><div class="sidebar_a3j0"><nav class="menu thin-scrollbar menu_cyFh"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro">我的知识库 😀</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/CSS/transition-animation-transform">CSS</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/DocusaurusTips/code-theme">Docusaurus使用技巧</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/TypeScript/basic-types">TypeScript</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/architecture/history">架构</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/Algorithm/algo">算法</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/Another/bigo">interview2</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/Cli/ESLint">Cli</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/DataBase/case">DataBase</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active hasHref_TwRn" href="/docs/DevOps/prometheus">DevOps</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/prometheus">[DevOps] 普罗米修斯</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/daima">[DevOps] 代码更新方法</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/jenkins">[DevOps] jenkins</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/paas">[DevOps] 容器-虚拟化</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/docker1">[DevOps] 容器技术管理工具-Docker(上)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/DevOps/docker2">[DevOps] 容器技术管理工具-Docker(中)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/docker3">[DevOps] 容器技术管理工具-Docker(下)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/dockercompose">[DevOps] 容器编排-docker compose</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/autopublish">[DevOps] 代码自动发布系统</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/18">[DevOps] Docker三剑客</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/kubernetes">[DevOps] kubernetes</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/Http/OptionsRequest">Http</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/Java/basic">Java</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/Linux/basic">Linux</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/Nginx/sign">Nginx</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/Node.js/buffer">Node.js</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/React/jsx">React</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/interview/http">interview</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/javascript/ecma">javascript</a></div></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_eoK2"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_e+kA"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_r8cw"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_zHA2"><div class="docItemContainer_oiyr"><article><div class="tocCollapsible_aw-L theme-doc-toc-mobile tocMobile_Tx6Y"><button type="button" class="clean-btn tocCollapsibleButton_zr6a">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>[DevOps] 容器技术管理工具-Docker(中)</h1></header><h2 class="anchor anchorWithStickyNavbar_y2LR" id="docker-镜像">docker 镜像<a class="hash-link" href="#docker-镜像" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_y2LR" id="容器与镜像之间的关系">容器与镜像之间的关系<a class="hash-link" href="#容器与镜像之间的关系" title="Direct link to heading">​</a></h3><ul><li>docker client 向 docker daemon 发起创建容器的请求</li><li>docker daemon 查找有无客户端需要的镜像</li><li>如无，则到容器的镜像仓库中下载需要的镜像</li><li>拿到容器镜像后，启动容器</li></ul><h3 class="anchor anchorWithStickyNavbar_y2LR" id="容器镜像介绍">容器镜像介绍<a class="hash-link" href="#容器镜像介绍" title="Direct link to heading">​</a></h3><p>Docker 镜像就是一组只读的目录，或者叫只读的 Docker 容器模板，镜像中含有一个 Docker 容器运行所需要的文件系统，所以我们说 Docker 镜像是启动一个 Docker 容器的基础。</p><p>可以将 Docker 镜像看成是 Docker 容器的静态时，也可将 Docker 容器看成是 Docker 镜像的运行时。</p><p>从 Docker 的官方文档来看，Docker 容器的定义和 Docker 镜像的定义几乎是相同，<code>Docker 容器和Docker 镜像的区别主要在于docker 容器多出了一个可写层。</code></p><p><img alt="wr" src="/assets/images/wr-13d86120757d29ab09ca4232e80d0e61.JPG"></p><p>容器中的进程就运行在这个可写层，这个可写层有两个状态，即运行态和退出态。当我们 docker run 运行容器后，docker 容器就进入了运行态，当我们停止正在运行中的容器时，docker 容器就进入了退出态。</p><p>我们将容器从运行态转为退出态时，期间发生的变更都会写入到容器的文件系统中(需要注意的是，此处不是写入到了 docker 镜像中)。</p><p>联合文件系统（UnionFS）是一种轻量级的高性能分层文件系统，它支持将文件系统中的修改信息作为一次提交，并层层叠加，同时可以将不同目录挂载到同一个虚拟文件系统下，应用看到的是挂载的最终结果。</p><p>联合文件系统是实现 Docker 镜像的技术基础。Docker 镜像可以通过分层来进行继承。例如，用户基于基础镜像（用来生成其他镜像的基础，往往没有父镜像）来制作各种不同的应用镜像。这些镜像共享同一个基础镜像层，提高了存储效率。此外，当用户改变了一个 Docker 镜像（比如升级程序到新的版本），则会创建一个新的层（layer）。因此，用户不用替换整个原镜像或者重新建立，只需要添加新层即可。用户分发镜像的时候，也只需要分发被改动的新层内容（增量部分）。这让 Docker 的镜像管理变得十分轻量级和快速。</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="制作基础镜像">制作基础镜像<a class="hash-link" href="#制作基础镜像" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_y2LR" id="1-安装一个最小化的操作系统主机">1. 安装一个最小化的操作系统主机<a class="hash-link" href="#1-安装一个最小化的操作系统主机" title="Direct link to heading">​</a></h3><p>虚拟机的镜像模板中不仅仅包含文件系统, 还包括操作系统. 但是容器的镜像模板当中仅仅包含文件系统</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="2-打包操作系统的根目录">2. 打包操作系统的根目录<a class="hash-link" href="#2-打包操作系统的根目录" title="Direct link to heading">​</a></h3><p>为什么打包根目录, 因为根目录包含了整个操作系统里面的内容</p><p>启动状态的主机一定包含这个主机的进程对应的映射, 因此需要排除/proc</p><p>启动状态的主机一定包含这个主机的对应的映射, 因此需要排除/sys</p><div class="codeBlockContainer_J+bg language-shell theme-code-block"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># --numeric-owner 参数指打包过程中给所有的文件夹以及文件的用户名全部替换成数字</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># -cvf 创建显示文件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># / 代表打包到 / 目录</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@bogon ~</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># tar --numeric-owner --exclude=/proc --exclude=/sys -cvf centos7u6.tar /</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># ll -h 查看打包好的镜像</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># scp 镜像名.tar 目标ip:/目录名</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="3-把获取的根打包文件导入到-docker-host-主机中">3. 把获取的根打包文件导入到 Docker host 主机中<a class="hash-link" href="#3-把获取的根打包文件导入到-docker-host-主机中" title="Direct link to heading">​</a></h3><div class="codeBlockContainer_J+bg language-shell theme-code-block"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># 把上面打好的tar包导入到主机中变成基础镜像</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@bogon ~</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># docker import centos7u6.tar centos7u6:latest</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@bogon ~</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># docker image ls</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">REPOSITORY TAG IMAGE ID CREATED SIZE</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">centos7u6 latest 9223c5786c4c </span><span class="token number">15</span><span class="token plain"> seconds ago </span><span class="token number">1</span><span class="token plain">.5GB</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="4-使用基础镜像启动容器">4. 使用基础镜像启动容器<a class="hash-link" href="#4-使用基础镜像启动容器" title="Direct link to heading">​</a></h3><div class="codeBlockContainer_J+bg language-shell theme-code-block"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@bogon ~</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># docker run -it --name c1000 centos7u6:latest /bin/bash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@f56add98265c /</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># ls /proc</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token number">1</span><span class="token plain"> cpuinfo fs kmsg mounts slabinfo </span><span class="token function" style="color:rgb(80, 250, 123)">tty</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token number">22</span><span class="token plain"> crypto interrupts kpagecount mtrr softirqs </span><span class="token function" style="color:rgb(80, 250, 123)">uptime</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">acpi devices iomem kpageflags net </span><span class="token function" style="color:rgb(80, 250, 123)">stat</span><span class="token plain"> version</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">asound diskstats ioports loadavg pagetypeinfo swaps</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">vmallocinfo</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">buddyinfo dma irq locks partitions sys </span><span class="token function" style="color:rgb(80, 250, 123)">vmstat</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">bus driver kallsyms mdstat sched_debug sysrq-trigger zoneinfo</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">cgroups execdomains kcore meminfo schedstat sysvipc</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">cmdline fb keys misc scsi timer_list</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">consoles filesystems key-users modules self timer_stats</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@f56add98265c /</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># ip a s</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token number">1</span><span class="token plain">: lo: </span><span class="token operator">&lt;</span><span class="token plain">LOOPBACK,UP,LOWER_UP</span><span class="token operator">&gt;</span><span class="token plain"> mtu </span><span class="token number">65536</span><span class="token plain"> qdisc noqueue state UNKNOWN group default qlen</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token number">1000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">inet </span><span class="token number">127.0</span><span class="token plain">.0.1/8 scope </span><span class="token function" style="color:rgb(80, 250, 123)">host</span><span class="token plain"> lo</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">valid_lft forever preferred_lft forever</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token number">38</span><span class="token plain">: eth0@if39: </span><span class="token operator">&lt;</span><span class="token plain">BROADCAST,MULTICAST,UP,LOWER_UP</span><span class="token operator">&gt;</span><span class="token plain"> mtu </span><span class="token number">1500</span><span class="token plain"> qdisc noqueue state UP group</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">default</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">link/ether 02:42:ac:11:00:09 brd ff:ff:ff:ff:ff:ff link-netnsid </span><span class="token number">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">inet </span><span class="token number">172.17</span><span class="token plain">.0.9/16 brd </span><span class="token number">172.17</span><span class="token plain">.255.255 scope global eth0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">valid_lft forever preferred_lft forever</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><hr><h2 class="anchor anchorWithStickyNavbar_y2LR" id="制作应用镜像">制作应用镜像<a class="hash-link" href="#制作应用镜像" title="Direct link to heading">​</a></h2><p>应用镜像指应用程序运行的环境</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="使用-commit-提交镜像">使用 commit 提交镜像<a class="hash-link" href="#使用-commit-提交镜像" title="Direct link to heading">​</a></h3><p>使用容器的文件系统在基础镜像运行的容器中安装应用，此例使用 httpd</p><div class="codeBlockContainer_J+bg language-shell theme-code-block"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@f56add98265c /</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># yum -y install httpd</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>此时制作了一个容器, 还需要让这个容器变成镜像</p><p>使用 commit 命令对正在运行的容器提交为一个应用镜像</p><div class="codeBlockContainer_J+bg language-shell theme-code-block"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@bogon ~</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># docker commit c1000 centos7u6-httpd:v1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">sha256:7bc399ab72aa3335e383e58d709770fa5c3bfeee66cccf7976776e22fe5fedc7</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@bogon ~</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># docker images</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">REPOSITORY TAG IMAGE ID CREATED SIZE</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">centos7u6-httpd v1 7bc399ab72aa </span><span class="token number">5</span><span class="token plain"> seconds ago </span><span class="token number">1</span><span class="token plain">.67GB</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>此时可以使用应用镜像</p><div class="codeBlockContainer_J+bg language-shell theme-code-block"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@bogon ~</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># docker run -it centos7u6-httpd:v1 /bin/bash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@1abdebd392db /</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># echo &quot;ttt&quot; &gt;&gt; /var/www/html/index.html</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@1abdebd392db /</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># httpd -k start</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">AH00558: httpd: Could not reliably determine the server</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;s fully qualified domain name,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">using 172.17.0.10. Set the &#x27;</span><span class="token plain">ServerName&#x27; directive globally to suppress this message</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@1abdebd392db /</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># curl http://localhost</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">ttt</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_y2LR" id="使用-docker-build-创建指定应用容器镜像">使用 docker build 创建指定应用容器镜像<a class="hash-link" href="#使用-docker-build-创建指定应用容器镜像" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_y2LR" id="1-使用-docker-build-命令">1. 使用 docker build 命令<a class="hash-link" href="#1-使用-docker-build-命令" title="Direct link to heading">​</a></h3><h3 class="anchor anchorWithStickyNavbar_y2LR" id="2-基于-dockerfile">2. 基于 Dockerfile<a class="hash-link" href="#2-基于-dockerfile" title="Direct link to heading">​</a></h3><h3 class="anchor anchorWithStickyNavbar_y2LR" id="3-dockfile-原理">3. Dockfile 原理<a class="hash-link" href="#3-dockfile-原理" title="Direct link to heading">​</a></h3><p>在 Dockerfile 定义所要执行的命令，使用 docker build 创建镜像，过程中会按照 Dockerfile 所定义的内容打开临时性容器(使用 docker commit 进行提交)，把 Dockerfile 文件中的命令全部执行完成，就得到了一个容器应用镜像。</p><div class="admonition admonition-tip alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</h5></div><div class="admonition-content"><p>执行命令越多，最终得到的容器应用镜像越大，所以要做优化</p></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="4-dockerfile-关键字">4. Dockerfile 关键字<a class="hash-link" href="#4-dockerfile-关键字" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithStickyNavbar_y2LR" id="from指定基础-image"><strong>FROM（指定基础 image）</strong><a class="hash-link" href="#from指定基础-image" title="Direct link to heading">​</a></h4><p><code>格式:</code></p><ul><li>FROM <code>&lt;image&gt;</code> 指定基础 image 为该 image 的最后修改的版本</li><li>FROM <code>&lt;image&gt;:&lt;tag&gt;</code> 指定基础 image 为该 image 的一个 tag 版本</li></ul><h4 class="anchor anchorWithStickyNavbar_y2LR" id="maintainer用来指定镜像创建者信息"><strong>MAINTAINER（用来指定镜像创建者信息）</strong><a class="hash-link" href="#maintainer用来指定镜像创建者信息" title="Direct link to heading">​</a></h4><p><code>格式:</code></p><ul><li>MAINTAINER <code>&lt;name&gt;</code></li><li>例如: MAINTAINER &quot;smartgo <a href="mailto:smartgodevop@126.com" target="_blank" rel="noopener noreferrer">smartgodevop@126.com</a>&quot;</li></ul><h4 class="anchor anchorWithStickyNavbar_y2LR" id="run-运行命令"><strong>RUN (运行命令)</strong><a class="hash-link" href="#run-运行命令" title="Direct link to heading">​</a></h4><p><code>格式:</code></p><ul><li>RUN <code>&lt;command&gt;</code> (the command is run in a shell - /bin/sh -c)</li><li>RUN <!-- -->[&quot;executable&quot;, &quot;param1&quot;, &quot;param2&quot; ...]</li></ul><h4 class="anchor anchorWithStickyNavbar_y2LR" id="cmd设置-container-启动时执行的操作"><strong>CMD（设置 container 启动时执行的操作）</strong><a class="hash-link" href="#cmd设置-container-启动时执行的操作" title="Direct link to heading">​</a></h4><div class="admonition admonition-tip alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</h5></div><div class="admonition-content"><p>如果容器镜像中有此命令，启动容器时，不要手动让容器执行其它命令</p></div></div><p><code>格式:</code></p><ul><li>CMD <!-- -->[&quot;executable&quot;, &quot;param1&quot;, &quot;param2&quot; ...]</li></ul><h4 class="anchor anchorWithStickyNavbar_y2LR" id="entrypoint设置-container-启动时执行的操作">ENTRYPOINT（设置 container 启动时执行的操作）<a class="hash-link" href="#entrypoint设置-container-启动时执行的操作" title="Direct link to heading">​</a></h4><p><code>格式:</code></p><ul><li>ENTRYPOINT <!-- -->[&quot;executable&quot;, &quot;param1&quot;, &quot;param2&quot; ...]</li></ul><h4 class="anchor anchorWithStickyNavbar_y2LR" id="user设置-container-容器的用户">USER（设置 container 容器的用户）<a class="hash-link" href="#user设置-container-容器的用户" title="Direct link to heading">​</a></h4><p><code>格式:</code></p><ul><li>USER daemon</li></ul><h4 class="anchor anchorWithStickyNavbar_y2LR" id="expose指定容器需要映射到宿主机器的端口"><strong>EXPOSE（指定容器需要映射到宿主机器的端口）</strong><a class="hash-link" href="#expose指定容器需要映射到宿主机器的端口" title="Direct link to heading">​</a></h4><p>如果真实机当中有端口, 容器里面没有开启端口, 没法做映射, 所以需要给容器开端口</p><p><code>格式:</code></p><ul><li>EXPOSE <code>&lt;port&gt; [&lt;port&gt;...]</code></li></ul><h4 class="anchor anchorWithStickyNavbar_y2LR" id="env用于设置环境变量">ENV（用于设置环境变量）<a class="hash-link" href="#env用于设置环境变量" title="Direct link to heading">​</a></h4><p><code>格式:</code></p><ul><li>ENV <code>&lt;key&gt; &lt;value&gt;</code></li></ul><h4 class="anchor anchorWithStickyNavbar_y2LR" id="add从-src-复制文件到-container-的-dest-路径"><strong>ADD（从 src 复制文件到 container 的 dest 路径）</strong><a class="hash-link" href="#add从-src-复制文件到-container-的-dest-路径" title="Direct link to heading">​</a></h4><p>把 docker 主机的文件添加到容器里</p><p><code>格式:</code></p><ul><li>ADD <code>&lt;src&gt; &lt;dest&gt;</code></li></ul><h4 class="anchor anchorWithStickyNavbar_y2LR" id="volume指定挂载点">VOLUME（指定挂载点）<a class="hash-link" href="#volume指定挂载点" title="Direct link to heading">​</a></h4><p><code>格式:</code></p><ul><li>VOLUME <code>[&quot;&lt;mountpoint&gt;&quot;]</code></li></ul><h4 class="anchor anchorWithStickyNavbar_y2LR" id="workdir切换目录"><strong>WORKDIR（切换目录）</strong><a class="hash-link" href="#workdir切换目录" title="Direct link to heading">​</a></h4><p>比如现在登录进容器, 位于根目录, 但是脚本放到 /opt 文件夹下, 原来工作是在根目录下工作现在执行脚本要切换路径, 使用 workdir 切换到/opt</p><p><code>格式:</code></p><ul><li>WORKDIR /path/to/workdir</li></ul><hr><h2 class="anchor anchorWithStickyNavbar_y2LR" id="dockerfile-应用案例一">Dockerfile 应用案例一<a class="hash-link" href="#dockerfile-应用案例一" title="Direct link to heading">​</a></h2><p><code>目的</code>：通过 Dockerfile 创建一个可以在启动容器时就直接启动 httpd 应用的镜像</p><p><code>步骤</code>：</p><ul><li>创建一个目录，用于存储 Dockerfile 所使用的文件</li><li>在此目录中创建 Dockerfile 文件及制作镜像所使用到的文件</li><li>在此此目录中使用 docker build 创建镜像(读取 Dockerfile 文件)</li><li>使用创建的镜像启动容器</li></ul><h3 class="anchor anchorWithStickyNavbar_y2LR" id="过程"><code>过程</code>：<a class="hash-link" href="#过程" title="Direct link to heading">​</a></h3><ol><li>创建目录</li></ol><div class="codeBlockContainer_J+bg language-shell theme-code-block"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@bogon ~</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># mkdir test</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@bogon ~</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># cd test</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@bogon ~</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">vim run-httpd.sh</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">#文件里写入</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">#!/bin/bash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">rm</span><span class="token plain"> -rf /run/httpd/*   </span><span class="token comment" style="color:rgb(98, 114, 164)">#删除apache进程</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">exec</span><span class="token plain"> /sbin/httpd -D FOREGROUND  </span><span class="token comment" style="color:rgb(98, 114, 164)"># -D 用来指定apache运行在前端还是后端 FOREGROUND代表前端</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ol start="2"><li>进入目录并创建用于启动 httpd 的脚本文件</li></ol><div class="codeBlockContainer_J+bg language-shell theme-code-block"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@bogon test</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># cat run-httpd.sh</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">#!/bin/bash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">rm</span><span class="token plain"> -rf /run/httpd/*</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">exec</span><span class="token plain"> /sbin/httpd -D FOREGROUND</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ol start="3"><li>创建用于测试 httpd 是否可用的 index.htm</li></ol><div class="codeBlockContainer_J+bg language-shell theme-code-block"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@bogon test</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># cat index.html</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">It&#x27;s work</span><span class="token operator">!</span><span class="token operator">!</span><span class="token operator">!</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ol start="4"><li>创建 Dockerfile</li></ol><div class="codeBlockContainer_J+bg language-shell theme-code-block"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@bogon test</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># vim Dockerfile</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># 文件里写入</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">FROM centos7u6:latest</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">MAINTAINER </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;smartdocker@smartdocker@126.com&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">RUN yum clean all</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">RUN </span><span class="token function" style="color:rgb(80, 250, 123)">rpm</span><span class="token plain"> --rebuilddb </span><span class="token operator">&amp;&amp;</span><span class="token plain"> yum -y </span><span class="token function" style="color:rgb(80, 250, 123)">install</span><span class="token plain"> httpd</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">ADD run-httpd.sh /run-httpd.sh     </span><span class="token comment" style="color:rgb(98, 114, 164)"># 扔进来只有644权限, 也就是读读, 读写, 没有执行权限, 需要执行权限也就是下面 +x, -v 显示加权限过程</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">RUN </span><span class="token function" style="color:rgb(80, 250, 123)">chmod</span><span class="token plain"> -v +x /run-httpd.sh</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">ADD index.html /var/www/html/</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">EXPOSE </span><span class="token number">80</span><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># 是暴露容器的80端口</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">WORKDIR /  </span><span class="token comment" style="color:rgb(98, 114, 164)"># 切换目录到根, 才能找到执行/run-httpd.sh文件 因为在上面ADD命令决定了</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">CMD </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;/bin/bash&quot;</span><span class="token plain">,</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;/run-httpd.sh&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@bogon test</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># cat Dockerfile</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ol start="5"><li>使用 docker build 创建镜像，注意命令最后有一个点，点表示当前目录</li></ol><div class="codeBlockContainer_J+bg language-shell theme-code-block"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@bogon test</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># docker build -t centos7u6-base-httpd:v1 .</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ol start="6"><li>使用上述创建的应用容器启动容器</li></ol><div class="codeBlockContainer_J+bg language-shell theme-code-block"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@bogon test</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># docker run -d centos7u6-base-httpd:v1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># -d 代表容器在后台执行</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ol start="7"><li>验证容器及 httpd 是否可用</li></ol><div class="codeBlockContainer_J+bg language-shell theme-code-block"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@bogon test</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># docker inspect 31d #查看容器IP地址</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@bogon test</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># curl http://172.17.0.11</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">It&#x27;s work</span><span class="token operator">!</span><span class="token operator">!</span><span class="token operator">!</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><hr><h2 class="anchor anchorWithStickyNavbar_y2LR" id="替代原网站内容案例">替代原网站内容案例<a class="hash-link" href="#替代原网站内容案例" title="Direct link to heading">​</a></h2><div class="codeBlockContainer_J+bg language-shell theme-code-block"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@bogon test</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># mkdir /wwwroot</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@bogon test</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># echo &quot;wwwroot&quot; &gt;&gt; /wwwroot/index.html</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@bogon test</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># docker run -d -v /wwwroot:/var/www/html centos7u6-base-httpd:v1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">415e82ad0041aa18bcb92bc8edbdf9bd758915a8345c71266f51937de3a20a26</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@bogon test</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># docker inspect 415</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@bogon test</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># curl http://172.17.0.12</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">wwwroot</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><div class="admonition admonition-tip alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</h5></div><div class="admonition-content"><p>如果遇到 Rpmdb 错误，可以考虑安装：yum-plugin-ovl 软件包。</p></div></div><hr><h2 class="anchor anchorWithStickyNavbar_y2LR" id="把-nginx-应用容器化案例">把 nginx 应用容器化案例<a class="hash-link" href="#把-nginx-应用容器化案例" title="Direct link to heading">​</a></h2><p>要求：</p><ul><li>1、通过基础镜像做 nginx 应用镜像</li><li>2、使用 nginx 应用镜像启动容器时，nginx 要求启动</li><li>3、验证 nginx 服务是否启动</li></ul><p>步骤：</p><ul><li>1、使用哪一个基础 centos:latest</li><li>2、需要使用 epel YUM 源</li><li>3、安装 nginx</li><li>4、修改 nginx 配置文件，主要用于关闭 daemon 后台运行, 这样容器中有 nginx 一直在运行, 容器就不会关闭了</li><li>5、验证使用的测试页面</li></ul><p>过程:</p><ul><li>创建目录</li></ul><div class="codeBlockContainer_J+bg language-shell theme-code-block"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@localhost ~</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># mkdir nginxtest</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@localhost ~</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># cd nginxtest/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@localhost nginxtest</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)">#</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>创建测试文件</li></ul><div class="codeBlockContainer_J+bg language-shell theme-code-block"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@localhost nginxtest</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># echo &#x27;nginx s running!!!&#x27; &gt;&gt; index.html</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@localhost nginxtest</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># ls</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">index.html</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>创建 Dockerfile</li></ul><div class="codeBlockContainer_J+bg language-shell theme-code-block"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@localhost nginxtest</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># cat Dockerfile</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">FROM centos:latest</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">MAINTAINER </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;smartaiops&lt;smartaiops@126.com&gt;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># yum -y install 的-y 代表非交互式</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">RUN yum clean all </span><span class="token operator">&amp;&amp;</span><span class="token plain"> yum -y </span><span class="token function" style="color:rgb(80, 250, 123)">install</span><span class="token plain"> yum-plugin-ovl </span><span class="token operator">&amp;&amp;</span><span class="token plain"> yum -y </span><span class="token function" style="color:rgb(80, 250, 123)">install</span><span class="token plain"> epel-release</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">RUN yum -y </span><span class="token function" style="color:rgb(80, 250, 123)">install</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">ADD index.html /usr/share/nginx/html/</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">RUN </span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;daemon off;&quot;</span><span class="token plain"> </span><span class="token operator">&gt;&gt;</span><span class="token plain"> /etc/nginx/nginx.conf </span><span class="token comment" style="color:rgb(98, 114, 164)">#取消nginx以daemon身份运行</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">EXPOSE </span><span class="token number">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">CMD /usr/sbin/nginx</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>使用 docker build 创建 nginx 应用镜像</li></ul><div class="codeBlockContainer_J+bg language-shell theme-code-block"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@localhost nginxtest</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># docker build -t centos-nginx:v1 .</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># -t 代表 tag名是后面的</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># 如果不加 . 可以用 -f 绝对路径代替</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>启动容器验证 nginx 服务是否自动开启</li></ul><div class="codeBlockContainer_J+bg language-shell theme-code-block"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@localhost nginxtest</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># docker images</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">REPOSITORY TAG IMAGE ID CREATED SIZE</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">centos-nginx v1 cf23c20ff2cd </span><span class="token number">20</span><span class="token plain"> seconds ago 466MB</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@localhost nginxtest</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># docker run -d centos-nginx:v1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">5b1d6dae77d24d9c8dc136a5bf971ebe296e1463838bda46e586d07d6f572f6d</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@localhost nginxtest</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># docker ps</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">5b1d6dae77d2 centos-nginx:v1 </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;/bin/sh -c /usr/sbi…&quot;</span><span class="token plain"> </span><span class="token number">9</span><span class="token plain"> seconds ago Up </span><span class="token number">8</span><span class="token plain"> seconds </span><span class="token number">80</span><span class="token plain">/tcp upbeat_khayyam</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@localhost nginxtest</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># docker inspect 5b1d</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@localhost nginxtest</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># curl http://172.17.0.3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">nginx s running</span><span class="token operator">!</span><span class="token operator">!</span><span class="token operator">!</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_y2LR" id="容器镜像在-docker-host-存储位置">容器镜像在 docker host 存储位置<a class="hash-link" href="#容器镜像在-docker-host-存储位置" title="Direct link to heading">​</a></h2><p><img alt="dh" src="/assets/images/dh-3bb2f0657176dca5ac8fc9cab144405b.JPG"></p><p>从图中可以看出除了最上面的一层为读写层之外，下面的其他的层都是只读的镜像层，并且除了最下面的一层外，其他的层都有会有一个指针指向自己下面的一层镜像。</p><p>虽然统一文件系统(union file system)技术将不同的镜像层整合成一个统一的文件系统，为构成一个完整容器镜像的层提供了一个统一的视角，隐藏了多个层的复杂性，对用户来说只存在一个文件系统，但图中的这些层并不是不能看到的，如果需要查看的话可以进入运行 Docker 的机器上进行查看，从这些层中可以看到 Docker 内部实现的一些细节。</p><p><code>Docker 的容器镜像</code>和<code>容器本身的数据</code>都存放在服务器的 /var/lib/docker/ 这个路径下。不过不同的 linux 发行版存储方式上有差别，比如，在 ubuntu 发行版上存储方式为 AUFS，CentOS 发行版上的存储方式为 Overlay 或 Overlay2。</p><div class="admonition admonition-tip alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</h5></div><div class="admonition-content"><p>centos 系统 docker 默认使用存储驱动是 devicemapper，而这种存储驱动有两种模式 loop-lvm 和 direct-lvm，不巧默认又使用了比较低效的 loop-lvm。</p></div></div><p>OverlayFS 是一个类似于 AUFS 的现代联合文件系统，更快实现简单。</p><p>OverlayFS 是内核提供的文件系统，overlay 和 overlay2 是 docker 的存储驱动</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="overlay-及-overlay2-原理">Overlay 及 Overlay2 原理<a class="hash-link" href="#overlay-及-overlay2-原理" title="Direct link to heading">​</a></h3><p>OverlayFS 将单个 Linux 主机上的两个目录合并成一个目录。这些目录被称为层，统一过程被称为联合挂载。OverlayFS 底层目录称为 lowerdir， 高层目录称为 upperdir。合并统一视图称为 merged。当需要修改一个文件时，使用 CoW 将文件从只读的 Lower 复制到可写的 Upper 进行修改，结果也保存在 Upper 层。在 Docker 中，底下的只读层就是 image，可写层就是 Container。</p><p>overlay2 是 overlay 的改进版，只支持 4.0 以上内核添加了 Multiple lower layers in overlayfs 的特性，所以 overlay2 可以直接造成 muitiple lower layers 不用像 overlay 一样要通过硬链接的方式(最大 128 层) centos 的话支持 3.10.0-514 及以上内核版本也有此特性，所以消耗更少的 inode</p><p><code>本质区别是镜像层之间共享数据的方法不同</code></p><ul><li><p>overlay 共享数据方式是通过硬连接，只挂载一层,其他层通过最高层通过硬连接形式共享(增加了磁盘 inode 的负担)</p></li><li><p>而 overlay2 是通过每层的 lower 文件</p></li></ul><p><img alt="overlay" src="/assets/images/overlay-025643f967db19b53060d68b096e5ade.JPG"></p><p>如果 upperdir 和 lowerdir 有同名文件时会用 upperdir 的文件</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="查看-docker-默认使用的存储驱动方法">查看 docker 默认使用的存储驱动方法<a class="hash-link" href="#查看-docker-默认使用的存储驱动方法" title="Direct link to heading">​</a></h3><div class="codeBlockContainer_J+bg language-shell theme-code-block"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@bogon overlay2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># docker info</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Containers: </span><span class="token number">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Running: </span><span class="token number">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Paused: </span><span class="token number">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Stopped: </span><span class="token number">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Images: </span><span class="token number">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Server Version: </span><span class="token number">18.09</span><span class="token plain">.5</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Storage Driver: overlay2 </span><span class="token comment" style="color:rgb(98, 114, 164)">#注意此处</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Backing Filesystem: xfs</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Supports d_type: </span><span class="token boolean">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Native Overlay Diff: </span><span class="token boolean">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Logging Driver: json-file</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Cgroup Driver: cgroupfs</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Plugins:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># 以下略</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="docker-运行前">docker 运行前<a class="hash-link" href="#docker-运行前" title="Direct link to heading">​</a></h3><p>/var/lib/docker/overlay2 路径下的信息在不同的阶段会有变化，了解这几个阶段中新增的数据以及容器与镜像的存储结构的变化非常有利于我们对 Docker 容器以及 Docker 镜像的理解。</p><p>Docker 运行前、Docker 运行后、下载镜像后、运行容器后四个阶段中 Docker 存储的变化</p><ul><li>运行前</li></ul><p>没有启动 docker daemon 之间不会在/var/lib/目录中添加 docker 目录</p><ul><li>启动后</li></ul><div class="codeBlockContainer_J+bg language-shell theme-code-block"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@bogon ~</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># systemctl start docker</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@bogon ~</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># tree /var/lib/docker</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">/var/lib/docker</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">├── builder</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│ └── fscache.db</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">├── buildkit</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│ ├── cache.db</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│ ├── content</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│ │ └── ingest</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│ ├── executor</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│ ├── metadata.db</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│ └── snapshots.db</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">├── containers</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">├── image</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│ └── overlay2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│ ├── distribution</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│ ├── imagedb</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│ │ ├── content</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│ │ │ └── sha256</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│ │ └── metadata</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│ │ └── sha256</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│ ├── layerdb</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│ └── repositories.json</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">├── network</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│ └── files</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│ └── local-kv.db</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">├── overlay2 </span><span class="token comment" style="color:rgb(98, 114, 164)">#下载镜像后，存储在此目录中</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│ ├── backingFsBlockDev</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│ └── l</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">├── plugins</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│ ├── storage</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│ │ └── blobs</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│ │ └── tmp</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│ └── tmp</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">├── runtimes</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">├── swarm</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">├── tmp</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">├── trust</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">└── volumes</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">└── metadata.db</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token number">29</span><span class="token plain"> directories, </span><span class="token number">8</span><span class="token plain"> files</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>下载镜像后</li></ul><div class="codeBlockContainer_J+bg language-shell theme-code-block"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@bogon overlay2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># pwd</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">/var/lib/docker/overlay2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@bogon overlay2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># ls</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">2d297a77c653f510dce69815627fdb485462b1b2fc9e0078a9ecc5ca2d222c8d backingFsBlockDev l</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@bogon overlay2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># ls</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">2d297a77c653f510dce69815627fdb485462b1b2fc9e0078a9ecc5ca2d222c8d/</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">diff</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">link</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@bogon overlay2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># ls</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">2d297a77c653f510dce69815627fdb485462b1b2fc9e0078a9ecc5ca2d222c8d/diff/</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">anaconda-post.log dev home lib64 mnt proc run srv tmp var</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">bin etc lib media opt root sbin sys usr</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>centos 镜像只有一层</p><div class="codeBlockContainer_J+bg language-shell theme-code-block"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@bogon overlay2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># pwd</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">/var/lib/docker/overlay2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@bogon overlay2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># ls</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">2d297a77c653f510dce69815627fdb485462b1b2fc9e0078a9ecc5ca2d222c8d backingFsBlockDev l</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@bogon overlay2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># ll l</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">总用量 </span><span class="token number">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">lrwxrwxrwx </span><span class="token number">1</span><span class="token plain"> root root </span><span class="token number">72</span><span class="token plain"> </span><span class="token number">4</span><span class="token plain">月 </span><span class="token number">26</span><span class="token plain"> </span><span class="token number">12</span><span class="token plain">:58 MBRXMBFE2MYZYMO5RZLRLTMRGJ -</span><span class="token operator">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">..</span><span class="token plain">/2d297a77c653f510dce69815627fdb485462b1b2fc9e0078a9ecc5ca2d222c8d/diff</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>l 目录中包含了很多多软链接，使用短名称指向了其他层，短名称用于避免 mount 参数时达到页面大小的限制</p><ul><li>运行容器后</li></ul><p>Overlay2 容器结构</p><div class="codeBlockContainer_J+bg language-shell theme-code-block"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">#运行容器前</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@bogon overlay2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># ls</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">2d297a77c653f510dce69815627fdb485462b1b2fc9e0078a9ecc5ca2d222c8d backingFsBlockDev l</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">#运行容器后</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@bogon overlay2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># ls</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">00bd7dcc4c91f9a1a1257b8c0683fdd0b6dfe18af26597457e92b4d15c20cda0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">backingFsBlockDev</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">00bd7dcc4c91f9a1a1257b8c0683fdd0b6dfe18af26597457e92b4d15c20cda0-init l</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">2d297a77c653f510dce69815627fdb485462b1b2fc9e0078a9ecc5ca2d222c8d</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@bogon overlay2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># ll</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">00bd7dcc4c91f9a1a1257b8c0683fdd0b6dfe18af26597457e92b4d15c20cda0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">总用量 </span><span class="token number">8</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">drwxr-xr-x </span><span class="token number">2</span><span class="token plain"> root root </span><span class="token number">6</span><span class="token plain"> </span><span class="token number">4</span><span class="token plain">月 </span><span class="token number">26</span><span class="token plain"> </span><span class="token number">13</span><span class="token plain">:15 </span><span class="token function" style="color:rgb(80, 250, 123)">diff</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">-rw-r--r-- </span><span class="token number">1</span><span class="token plain"> root root </span><span class="token number">26</span><span class="token plain"> </span><span class="token number">4</span><span class="token plain">月 </span><span class="token number">26</span><span class="token plain"> </span><span class="token number">13</span><span class="token plain">:15 </span><span class="token function" style="color:rgb(80, 250, 123)">link</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">-rw-r--r-- </span><span class="token number">1</span><span class="token plain"> root root </span><span class="token number">57</span><span class="token plain"> </span><span class="token number">4</span><span class="token plain">月 </span><span class="token number">26</span><span class="token plain"> </span><span class="token number">13</span><span class="token plain">:15 lower</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">drwxr-xr-x </span><span class="token number">1</span><span class="token plain"> root root </span><span class="token number">6</span><span class="token plain"> </span><span class="token number">4</span><span class="token plain">月 </span><span class="token number">26</span><span class="token plain"> </span><span class="token number">13</span><span class="token plain">:15 merged</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">drwx------ </span><span class="token number">3</span><span class="token plain"> root root </span><span class="token number">18</span><span class="token plain"> </span><span class="token number">4</span><span class="token plain">月 </span><span class="token number">26</span><span class="token plain"> </span><span class="token number">13</span><span class="token plain">:15 work</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>启动一个容器，也是载/var/lib/docker/overlay2 目录下生成一层容器层，目录包括 diff，link，lower，merged，work。</p><p>diff 记录每一层自己内容的数据；link 记录该层链接目录（实际是 l 目录下到层的链接），比如在容器中创建目录或在 diff 新增该目录；创建容器时将 lower-id 指向的镜像层目录以及 upper 目录联合挂载到 merged 目录；work 用来完成如 copy-on_write 的操作。</p><p>启动容器后，可以在 docker host 查看 mount 情况</p><div class="codeBlockContainer_J+bg language-shell theme-code-block"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@bogon overlay2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># mount | grep overlay</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">overlay on</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">/var/lib/docker/overlay2/00bd7dcc4c91f9a1a1257b8c0683fdd0b6dfe18af26597457e92b4d15c20cd</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">a0/merged </span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">type</span><span class="token plain"> overlay</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">rw,relatime,lowerdir</span><span class="token operator">=</span><span class="token plain">/var/lib/docker/overlay2/l/4GXMF7JGUPRUBLW5SM4X4FY5R2:/var/lib/do</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">cker/overlay2/l/MBRXMBFE2MYZYMO5RZLRLTMRGJ,upperdir</span><span class="token operator">=</span><span class="token plain">/var/lib/docker/overlay2/00bd7dcc4c</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">91f9a1a1257b8c0683fdd0b6dfe18af26597457e92b4d15c20cda0/diff,workdir</span><span class="token operator">=</span><span class="token plain">/var/lib/docker/ove</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">rlay2/00bd7dcc4c91f9a1a1257b8c0683fdd0b6dfe18af26597457e92b4d15c20cda0/work</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/aokikoko/aokikoko.github.io/blob/main/website/docs/DevOps/docker2.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_mS5F" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_mt2f"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/DevOps/docker1"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">[DevOps] 容器技术管理工具-Docker(上)</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/DevOps/docker3"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">[DevOps] 容器技术管理工具-Docker(下)</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#docker-镜像" class="table-of-contents__link toc-highlight">docker 镜像</a><ul><li><a href="#容器与镜像之间的关系" class="table-of-contents__link toc-highlight">容器与镜像之间的关系</a></li><li><a href="#容器镜像介绍" class="table-of-contents__link toc-highlight">容器镜像介绍</a></li></ul></li><li><a href="#制作基础镜像" class="table-of-contents__link toc-highlight">制作基础镜像</a><ul><li><a href="#1-安装一个最小化的操作系统主机" class="table-of-contents__link toc-highlight">1. 安装一个最小化的操作系统主机</a></li><li><a href="#2-打包操作系统的根目录" class="table-of-contents__link toc-highlight">2. 打包操作系统的根目录</a></li><li><a href="#3-把获取的根打包文件导入到-docker-host-主机中" class="table-of-contents__link toc-highlight">3. 把获取的根打包文件导入到 Docker host 主机中</a></li><li><a href="#4-使用基础镜像启动容器" class="table-of-contents__link toc-highlight">4. 使用基础镜像启动容器</a></li></ul></li><li><a href="#制作应用镜像" class="table-of-contents__link toc-highlight">制作应用镜像</a><ul><li><a href="#使用-commit-提交镜像" class="table-of-contents__link toc-highlight">使用 commit 提交镜像</a></li></ul></li><li><a href="#使用-docker-build-创建指定应用容器镜像" class="table-of-contents__link toc-highlight">使用 docker build 创建指定应用容器镜像</a><ul><li><a href="#1-使用-docker-build-命令" class="table-of-contents__link toc-highlight">1. 使用 docker build 命令</a></li><li><a href="#2-基于-dockerfile" class="table-of-contents__link toc-highlight">2. 基于 Dockerfile</a></li><li><a href="#3-dockfile-原理" class="table-of-contents__link toc-highlight">3. Dockfile 原理</a></li><li><a href="#4-dockerfile-关键字" class="table-of-contents__link toc-highlight">4. Dockerfile 关键字</a></li></ul></li><li><a href="#dockerfile-应用案例一" class="table-of-contents__link toc-highlight">Dockerfile 应用案例一</a><ul><li><a href="#过程" class="table-of-contents__link toc-highlight"><code>过程</code>：</a></li></ul></li><li><a href="#替代原网站内容案例" class="table-of-contents__link toc-highlight">替代原网站内容案例</a></li><li><a href="#把-nginx-应用容器化案例" class="table-of-contents__link toc-highlight">把 nginx 应用容器化案例</a></li><li><a href="#容器镜像在-docker-host-存储位置" class="table-of-contents__link toc-highlight">容器镜像在 docker host 存储位置</a><ul><li><a href="#overlay-及-overlay2-原理" class="table-of-contents__link toc-highlight">Overlay 及 Overlay2 原理</a></li><li><a href="#查看-docker-默认使用的存储驱动方法" class="table-of-contents__link toc-highlight">查看 docker 默认使用的存储驱动方法</a></li><li><a href="#docker-运行前" class="table-of-contents__link toc-highlight">docker 运行前</a></li></ul></li></ul></div></div></div></div></main></div></div></div>
<script src="/assets/js/runtime~main.84ec8b59.js"></script>
<script src="/assets/js/main.b4022aec.js"></script>
</body>
</html>