<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.14">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Aoki 的自留地 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Aoki 的自留地 Atom Feed">
<link rel="search" type="application/opensearchdescription+xml" title="Aoki 的自留地" href="/opensearch.xml"><title data-react-helmet="true">[Nginx] 企业架构双点服务器HA-高可用 | Aoki 的自留地</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://phero.live/docs/Nginx/ha"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="current"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="[Nginx] 企业架构双点服务器HA-高可用 | Aoki 的自留地"><meta data-react-helmet="true" name="description" content="背景描述及其方案设计"><meta data-react-helmet="true" property="og:description" content="背景描述及其方案设计"><link data-react-helmet="true" rel="icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://phero.live/docs/Nginx/ha"><link data-react-helmet="true" rel="alternate" href="https://phero.live/docs/Nginx/ha" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://phero.live/docs/Nginx/ha" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BMRZNSN9O0-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.23909136.css">
<link rel="preload" href="/assets/js/runtime~main.c2d35455.js" as="script">
<link rel="preload" href="/assets/js/main.dd54a102.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top navbar--dark"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_TMUO themedImage--light_4Vu1"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_TMUO themedImage--dark_uzRr"></div><b class="navbar__title">Aoki</b></a><a class="navbar__item navbar__link navbar__link--active" href="/docs/intro">笔记</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/aokikoko" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_iYfV toggle_2i4l toggleDisabled_xj38"><div class="toggleTrack_t-f2" role="button" tabindex="-1"><div class="toggleTrackCheck_mk7D"><span class="toggleIcon_pHJ9">🌜</span></div><div class="toggleTrackX_dm8H"><span class="toggleIcon_pHJ9">🌞</span></div><div class="toggleTrackThumb_W6To"></div></div><input type="checkbox" class="toggleScreenReader_h9qa" aria-label="Switch between dark and light mode"></div><div class="searchBox_Utm0"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_lDyR"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_i9tI" type="button"></button><aside class="docSidebarContainer_0YBq"><div class="sidebar_a3j0"><nav class="menu thin-scrollbar menu_cyFh"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro">我的知识库 😀</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/CSS/transition-animation-transform">CSS</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/DocusaurusTips/code-theme">Docusaurus使用技巧</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/TypeScript/basic-types">TypeScript</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/Another/bigo">算法小题目</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/architecture/history">架构</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/Cli/ESLint">Cli</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/DevOps/prometheus">DevOps</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/Http/OptionsRequest">Http</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/Java/basic">Java</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/Linux/basic">Linux</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/Mysql/case">Mysql</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active hasHref_TwRn" href="/docs/Nginx/sign">Nginx</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Nginx/sign">[Nginx] 信号参数及配置文件介绍</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Nginx/server">[Nginx] 企业级常见配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Nginx/gzip">[Nginx] 实现gzip压缩与日志查看</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Nginx/location">[Nginx] URL匹配之location</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Nginx/return">[Nginx] URL重写</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Nginx/safe">[Nginx] 安全</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/Nginx/ha">[Nginx] 企业架构双点服务器HA-高可用</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Nginx/lb">[Nginx] 企业架构高可用负载均衡LB服务器</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Nginx/lvs">[Nginx] 企业架构LB-负载均衡之LVS实现</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/Node.js/buffer">Node.js</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/React/jsx">React</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/interview/http">interview</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/javascript/ecma">javascript</a></div></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_eoK2"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_e+kA"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_r8cw"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_zHA2"><div class="docItemContainer_oiyr"><article><div class="tocCollapsible_aw-L theme-doc-toc-mobile tocMobile_Tx6Y"><button type="button" class="clean-btn tocCollapsibleButton_zr6a">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>[Nginx] 企业架构双点服务器HA-高可用</h1></header><h2 class="anchor anchorWithStickyNavbar_y2LR" id="背景描述及其方案设计">背景描述及其方案设计<a class="hash-link" href="#背景描述及其方案设计" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_y2LR" id="1业务背景描述">1、业务背景描述<a class="hash-link" href="#1业务背景描述" title="Direct link to heading">​</a></h3><p>​ 随着用户量增多，单台 WEB 服务器，压力越来越大。虽然单台 WEB 服务器，目前可以完成工作任务。但是如果一旦宕机，用户就完全失去服务了，用户体验特别不好。需要备用一台服务器进行使用，主服务器宕机之后，快速切换为备用服务器</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="2模拟运维设计方案">2、模拟运维设计方案<a class="hash-link" href="#2模拟运维设计方案" title="Direct link to heading">​</a></h3><p>在之前架构中，先将数据库服务器单独迁移</p><p><img alt="ha1" src="/assets/images/ha1-36de72211be3bd7550a8e88e7a1bb579.jpg"></p><p>针对 web 服务器单点故障，升级为主备服务器架构</p><p><img alt="ha2" src="/assets/images/ha2-45fd75f790d30e5525bca70cb0bc5f25.jpg"></p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="数据库服务器迁移">数据库服务器迁移<a class="hash-link" href="#数据库服务器迁移" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_y2LR" id="1服务器-ip">1、服务器 ip<a class="hash-link" href="#1服务器-ip" title="Direct link to heading">​</a></h3><blockquote><p>server01 WEB 服务器 master 192.168.17.102</p><p>server02 数据库服务器 192.168.17.100</p><p>server03 WEB 服务器 backup 192.168.17.101</p></blockquote><h3 class="anchor anchorWithStickyNavbar_y2LR" id="2服务器基本配置">2、服务器基本配置<a class="hash-link" href="#2服务器基本配置" title="Direct link to heading">​</a></h3><p>根据之前的服务器基本环境的要求进行配置</p><p>因为是克隆获取虚拟机，所以只需要进行 IP 和 MAC 地址的修改即可。</p><div class="codeBlockContainer_J+bg language-shell theme-code-block"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">#1、删除原有网卡mac地址记录信息</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">shell </span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">cd</span><span class="token plain"> /etc/udev/rules.d</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">shell </span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">rm</span><span class="token plain"> -rf </span><span class="token number">70</span><span class="token plain">-persistent-net.rules</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">#2、删除eth0里的mac地址项 HWADDR参数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">#3、修改主机名称</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">shell </span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">sed</span><span class="token plain"> -i </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;s/server01/server02/&quot;</span><span class="token plain"> /etc/sysconfig/network</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">#4、启动之后，把hosts文件对应也做解析</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="3数据备份和迁移">3、数据备份和迁移<a class="hash-link" href="#3数据备份和迁移" title="Direct link to heading">​</a></h3><p><strong>① 源数据库服务器导出数据</strong></p><div class="codeBlockContainer_J+bg language-shell theme-code-block"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">#源数据库是server01 在server01上操作</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">shell </span><span class="token operator">&gt;</span><span class="token plain"> mysqldump -uroot -p --database tp5shop </span><span class="token operator">&gt;</span><span class="token plain"> /root/tp5shop.sql</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><strong>② 导入数据到新数据库服务器</strong></p><div class="codeBlockContainer_J+bg language-mysql theme-code-block"><div class="codeBlockContent_csEI mysql"><pre tabindex="0" class="prism-code language-mysql codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">#因为数据库服务器克隆来的，所有本身具有数据 可以删除了库，模拟新机器，重新导入</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">mysql &gt; drop database tp5shop;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#创建数据库并导入数据</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">mysql &gt; create database tp5shop;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">mysql &gt; use tp5shop;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">mysql &gt; source /root/tp5shop.sql;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><strong>③ 在 server02 MySQL 服务器中建立远程连接用户并授予权限</strong></p><div class="codeBlockContainer_J+bg language-mysql theme-code-block"><div class="codeBlockContent_csEI mysql"><pre tabindex="0" class="prism-code language-mysql codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">mysql &gt; grant all on tp5shop.* to &#x27;tp5shop&#x27;@&#x27;192.168.17.%&#x27; identified by &#x27;$Abc3721&#x27;;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><strong>④ 修改项目数据库配置文件</strong></p><div class="codeBlockContainer_J+bg language-shell theme-code-block"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">shell </span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">vim</span><span class="token plain"> /usr/local/nginx/html/tp5shop/application/database.php</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>修改参考示例：</p><div class="codeBlockContainer_J+bg language-php theme-code-block"><div class="codeBlockContent_csEI php"><pre tabindex="0" class="prism-code language-php codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">return [</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // 数据库类型</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &#x27;type&#x27;            =&gt; &#x27;mysql&#x27;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // 服务器地址</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &#x27;hostname&#x27;        =&gt; &#x27;192.168.17.100&#x27;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // 数据库名</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &#x27;database&#x27;        =&gt; &#x27;tp5shop&#x27;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // 用户名</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &#x27;username&#x27;        =&gt; &#x27;tp5shop&#x27;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // 密码</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &#x27;password&#x27;        =&gt; &#x27;$Abc3721&#x27;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // 端口</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &#x27;hostport&#x27;        =&gt; &#x27;3306&#x27;,</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><strong>⑤ 访问页面，查看业务使用情况</strong></p><hr><h2 class="anchor anchorWithStickyNavbar_y2LR" id="高可用服务搭建">高可用服务搭建<a class="hash-link" href="#高可用服务搭建" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_y2LR" id="1ha-高可用">1、HA 高可用<a class="hash-link" href="#1ha-高可用" title="Direct link to heading">​</a></h3><p>​ 高可用 HA（High Availability）是分布式系统架构设计中必须考虑的因素之一，它通常是指通过设计，减少系统服务不可用的时间。假设系统一直能够提供服务，我们说系统的可用性是 100%。如果系统每运行 100 个时间单位，会有 1 个时间单位无法提供服务，我们说系统的可用性是 99%。==很多公司的高可用目标是 4 个 9，也就是 99.99%，这就意味着，系统的年停机时间为 0.876 个小时==。</p><table><thead><tr><th><strong>描述</strong></th><th><strong>通俗叫法</strong></th><th><strong>可用性级别</strong></th><th><strong>年度停机时间</strong></th></tr></thead><tbody><tr><td>基本可用性</td><td>2 个 9</td><td>99%</td><td>87.6 小时</td></tr><tr><td>较高可用性</td><td>3 个 9</td><td>99.9%</td><td>8.8 小时</td></tr><tr><td><strong>具有故障自动恢复能力的可用性</strong></td><td><strong>4 个 9</strong></td><td><strong>99.99%</strong></td><td><strong>53 分钟</strong></td></tr><tr><td>极高可用性</td><td>5 个 9</td><td>99.999%</td><td>5 分钟</td></tr></tbody></table><blockquote><p><strong>实现高可用的核心点：</strong></p><p>① 冗余（多台服务器）</p><p>② 自动切换</p></blockquote><p>备份服务器：</p><p>冷备 服务器不启用（域名不解析），使用的时候再开启，需要手动切换</p><p>热备 服务器在等待状态（监控主服务器状态），一旦主宕机，备就接管，自动切换</p><p>实现热备，引入 VIP 的切换</p><p><img alt="ha3" src="/assets/images/ha3-57bd73db814df29a787a75d8a18f7dd8.jpg"></p><p><strong>通过 VIP 的方式，切换主备服务器</strong></p><p>① 默认 VIP 绑定在主服务器（master）</p><p>②master 不可用，就切换 VIP 到备份服务器（backup）</p><p>③ 用户可以使用到连续性更好的服务，通过 VIP 访问服务器</p><p><strong>常用来单独实现高可用的软件：</strong></p><p><code>①keepalived</code></p><p>②heartbeat 较早 属于 redhat HA 工程的一部分</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="2keepalived-介绍">2、keepalived 介绍<a class="hash-link" href="#2keepalived-介绍" title="Direct link to heading">​</a></h3><p>​ Keepalived 软件起初是专为 LVS 负载均衡软件设计的，用来管理并监控 LVS 集群系统中各个服务节点的状态，后来又加入了可以实现高可用的 VRRP 功能。因此，Keepalived 除了能够管理 LVS 软件外，还可以作为其他服务（例如：Nginx、Haproxy、MySQL 等）的高可用解决方案软件</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="3keepalived-组成和原理">3、keepalived 组成和原理<a class="hash-link" href="#3keepalived-组成和原理" title="Direct link to heading">​</a></h3><p>​ Keepalived 软件主要是通过 VRRP 协议实现高可用功能的。</p><p>​ VRRP 是 Virtual Router RedundancyProtocol(虚拟路由器冗余协议）的缩写，VRRP 出现的目的就是为了解决静态路由单点故障问题的，它能够保证当个别节点宕机时，整个网络可以不间断地运行。</p><p>​ 虚拟路由冗余协议，可以认为是实现路由器高可用的协议，即将 N 台提供相同功能的路由器组成一个路由器组，这个组里面有一个 master 和多个 backup，master 上面有一个对外提供服务的 vip（该路由器所在局域网内其他机器的默认路由为该 vip），master 会发组播，当 backup 收不到 vrrp 包时就认为 master 宕掉了，这时就需要根据 VRRP 的优先级来选举一个 backup 当 master。这样的话就可以保证路由器的高可用了。</p><p><img alt="ha4" src="/assets/images/ha4-7e7eafd5810a2a3f371d42faf203c9f5.jpg">
<img alt="ha5" src="/assets/images/ha5-61bf24b1c2c206f5af56accb9f2f76fb.JPG"></p><p>Keepalived 的功能体系结构，大致分两层：<strong>用户空间（user space）和内核空间（kernel space）</strong>。</p><p><strong>内核空间：</strong></p><p>主要包括 IPVS（IP 虚拟服务器，用于实现网络服务的负载均衡）和 NETLINK（提供高级路由及其他相关的网络功能）两个部份。</p><p><strong>用户空间：</strong></p><blockquote><p>WatchDog：负载监控 checkers 和 VRRP 进程的状况</p><p>VRRP Stack：负载均衡器之间的失败切换 FailOver，如果只用一个负载均衡器，则 VRRP 不是必须的。</p><p>Checkers：负责真实服务器的健康检查 healthchecking，是 keepalived 最主要的功能。换言之，可以没有 VRRP Stack，但健康检查 healthchecking 是一定要有的。</p><p>IPVS wrapper：用户发送设定的规则到内核 ipvs 代码</p><p>Netlink Reflector：用来设定 vrrp 的 vip 地址等。</p></blockquote><p>keepalived 主要使用三个模块，分别是 core、check 和 vrrp。</p><p>core 模块为 keepalived 的核心，负责主进程的启动、维护以及全局配置文件的加载和解析。</p><p>check 负责健康检查，包括常见的各种检查方式。</p><p>vrrp 模块是来实现 VRRP 协议的。</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="4安装配置启动-keepalived">4、安装配置启动 keepalived<a class="hash-link" href="#4安装配置启动-keepalived" title="Direct link to heading">​</a></h3><p>master 和 backup 都需要进行安装，也就是 server01 和 server03 机器</p><div class="codeBlockContainer_J+bg language-shell theme-code-block"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">#安装keepalived</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">shell </span><span class="token operator">&gt;</span><span class="token plain"> yum -y </span><span class="token function" style="color:rgb(80, 250, 123)">install</span><span class="token plain"> keepalived</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><table><thead><tr><th>主机名称</th><th>服务器 IP</th><th></th></tr></thead><tbody><tr><td>server01</td><td>192.168.17.102</td><td>master</td></tr><tr><td>server03</td><td>192.168.17.101</td><td>backup</td></tr></tbody></table><p><strong>keepalived 需要使用的目录和文件：</strong></p><table><thead><tr><th>文件或者目录</th><th>作用</th></tr></thead><tbody><tr><td>/etc/keepalived/keepalived.conf</td><td>生效的配置文件</td></tr><tr><td>/etc/init.d/keepalived</td><td>服务器管理脚本</td></tr><tr><td>/var/log/messages</td><td>日志信息</td></tr></tbody></table><p><strong>配置 keepalived</strong></p><p><strong>① 备份主备服务器的配置文件</strong></p><div class="codeBlockContainer_J+bg language-shell theme-code-block"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">shell </span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">cd</span><span class="token plain">  /etc/keepalived</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">shell </span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">cp</span><span class="token plain"> keepalived.conf keepalived.conf_bak</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><strong>② 分别修改主备服务器配置文件</strong></p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">shell &gt; vim keepalived.conf</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><strong>示例配置文件说明</strong></p><div class="codeBlockContainer_J+bg language-shell theme-code-block"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token operator">!</span><span class="token plain"> Configuration File </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> keepalived</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">#发送邮件的配置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">global_defs </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   notification_email </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     acassen@firewall.loc</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     failover@firewall.loc</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     sysadmin@firewall.loc</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   notification_email_from Alexandre.Cassen@firewall.loc</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   smtp_server </span><span class="token number">192.168</span><span class="token plain">.200.1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   smtp_connect_timeout </span><span class="token number">30</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   router_id LVS_DEVEL</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">#vrrp协议的配置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">vrrp_instance VI_1 </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">#工作模式</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    state MASTER</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">#监听的网卡</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    interface eth0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">#虚拟路由id 需要和备服务器一致</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    virtual_router_id </span><span class="token number">51</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">#权重 优先级</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    priority </span><span class="token number">100</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">#vrrp包的发送周期  1s</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    advert_int </span><span class="token number">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">#权限验证</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    authentication </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        auth_type PASS</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        auth_pass </span><span class="token number">1111</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">#需要绑定切换的VIP</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    virtual_ipaddress </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token number">192.168</span><span class="token plain">.200.16</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token number">192.168</span><span class="token plain">.200.17</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token number">192.168</span><span class="token plain">.200.18</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>主服务器</p><div class="codeBlockContainer_J+bg language-shell theme-code-block"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token operator">!</span><span class="token plain"> Configuration File </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> keepalived</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">global_defs </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   notification_email </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     acassen@firewall.loc</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     failover@firewall.loc</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     sysadmin@firewall.loc</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   notification_email_from Alexandre.Cassen@firewall.loc</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   smtp_server </span><span class="token number">192.168</span><span class="token plain">.200.1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   smtp_connect_timeout </span><span class="token number">30</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   router_id LVS_DEVEL</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">vrrp_instance VI_1 </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    state MASTER</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    interface eth0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    virtual_router_id </span><span class="token number">51</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    priority </span><span class="token number">100</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    advert_int </span><span class="token number">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    authentication </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        auth_type PASS</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        auth_pass </span><span class="token number">1111</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">#master默认只需要修改使用VIP即可</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    virtual_ipaddress </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token number">192.168</span><span class="token plain">.17.200</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>备服务器</p><div class="codeBlockContainer_J+bg language-shell theme-code-block"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token operator">!</span><span class="token plain"> Configuration File </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> keepalived</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">global_defs </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   notification_email </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     acassen@firewall.loc</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     failover@firewall.loc</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     sysadmin@firewall.loc</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   notification_email_from Alexandre.Cassen@firewall.loc</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   smtp_server </span><span class="token number">192.168</span><span class="token plain">.200.1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   smtp_connect_timeout </span><span class="token number">30</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   router_id LVS_DEVEL</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">vrrp_instance VI_1 </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">#修改工作模式为备</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    state BACKUP</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    interface eth0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    virtual_router_id </span><span class="token number">51</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    priority </span><span class="token number">100</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    advert_int </span><span class="token number">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    authentication </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        auth_type PASS</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        auth_pass </span><span class="token number">1111</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">#注意修改VIP</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    virtual_ipaddress </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token number">192.168</span><span class="token plain">.17.200</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><strong>③ 分别按照顺序启动主服务器和备服务器的 keepalived</strong></p><div class="codeBlockContainer_J+bg language-shell theme-code-block"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">shell </span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">service</span><span class="token plain"> keepalived start</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><strong>④ 查看主备服务器的网卡信息</strong></p><div class="codeBlockContainer_J+bg language-shell theme-code-block"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">#需要通过ip a命令查看  分别在server01和server03查看</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">shell </span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">ip</span><span class="token plain"> a</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>##5、模拟服务器不可用 VIP 切换</p><p>服务器整机不可用，常见于服务器断网，或者断电关机等。</p><p><strong>方法一：模拟主服务器断电关闭</strong></p><div class="codeBlockContainer_J+bg language-shell theme-code-block"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">#关闭主服务器  VIP所在服务器</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">shell </span><span class="token operator">&gt;</span><span class="token plain"> poweroff</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><strong>方法二：模拟主服务器断网</strong></p><div class="codeBlockContainer_J+bg language-shell theme-code-block"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">#关闭VIP所在服务器的网卡  使其不能够联网</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">shell </span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">service</span><span class="token plain"> network stop</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>通过以上实验检测，发现当主服务器整机不可用时，VIP 会切换到备用服务器</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="实现服务-ha">实现服务 HA<a class="hash-link" href="#实现服务-ha" title="Direct link to heading">​</a></h2><p>​ 通过 keepalived 可以直接实现主服务器整机不可用，实现 VIP 的切换。保证用户可以通过 VIP 进行访问服务。</p><p>但是实际情况下，往往并不是服务器整机不可用，只是对应的服务或者软件不可用。</p><p>比如说：nginx 提供的 web 服务，nginx 进程关闭</p><p>就需要检测当 nginx 不可用时，就切换 VIP</p><p><strong>实现过程分析：</strong></p><p>VIP 实际是由 keepalived 进行绑定的，所以当 nginx 服务不可用时，就关闭当前机器的 keepalived 即可，释放 VIP。进而绑定到其他备用服务器。</p><p>① 编写服务检测脚本，实现检测 nginx 是否可用，不可用则关闭当前所在主机的 keepalived</p><p>② 在 keepalived 配置中调用检测服务脚本</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="1nginx-服务可用检测脚本">1、Nginx 服务可用检测脚本<a class="hash-link" href="#1nginx-服务可用检测脚本" title="Direct link to heading">​</a></h3><p>主备服务器都要实现此脚本</p><p><strong>① 编写测试脚本 赋予执行权限</strong></p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">shell &gt; cd /etc/keepalived</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">shell &gt; vim check_nginx.sh</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><strong>脚本内容：</strong></p><div class="codeBlockContainer_J+bg language-shell theme-code-block"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token shebang important">#!/bin/bash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">nginx_status</span><span class="token operator">=</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">`</span><span class="token variable function" style="color:rgb(80, 250, 123);font-style:italic">ps</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> -C nginx --no-header </span><span class="token variable operator" style="color:rgb(189, 147, 249);font-style:italic">|</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable function" style="color:rgb(80, 250, 123);font-style:italic">wc</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> -l</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$nginx_status</span><span class="token plain"> -eq </span><span class="token number">0</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   </span><span class="token function" style="color:rgb(80, 250, 123)">service</span><span class="token plain"> keepalived stop</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">fi</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>赋予脚本执行权限 方便之后其他软件调用执行</p><div class="codeBlockContainer_J+bg language-shell theme-code-block"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">shell </span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">chmod</span><span class="token plain"> +x check_nginx.sh</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><strong>② 测试脚本可用性</strong></p><p>启动 nginx 和 keepalived</p><p>关闭 nginx 执行脚本 查看 keepalived 是否也关闭</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="2模拟宕机实现服务切换">2、模拟宕机实现服务切换<a class="hash-link" href="#2模拟宕机实现服务切换" title="Direct link to heading">​</a></h3><p>在多台服务器中配置 keepalived 定时触发检测 nginx 的脚本模块</p><div class="codeBlockContainer_J+bg language-shell theme-code-block"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">#在vrrp_instance外上面定义</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">vrrp_script check_nginx </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   </span><span class="token comment" style="color:rgb(98, 114, 164)">#调用脚本地址</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   script  /etc/keepalived/check_nginx.sh</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   </span><span class="token comment" style="color:rgb(98, 114, 164)">#检测间隔时间</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   interval </span><span class="token number">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">#在vrrp_instance里调用</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">track_script </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">#上线定义的名称</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    check_nginx</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>##3、实现 web 服务器高可用</p><p>以上案例已经实现了，服务不可用 VIP 切换到可用服务器。</p><p>现在需求用户的服务是连续不间断的，故<strong>用户需要通过 VIP 进行访问</strong></p><p><strong>① 解析域名到 VIP</strong></p><p><strong>② 模拟用户访问</strong></p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="keepalived-的配置补充">keepalived 的配置补充<a class="hash-link" href="#keepalived-的配置补充" title="Direct link to heading">​</a></h2><blockquote><p>脑裂（裂脑）：vip 出现在了多台机器上。网络不通畅，禁用了数据包，主备服务器没法通讯，造成备服务器认为主服务器不可用，绑定 VIP，主服务器 VIP 不会释放。</p><p>解决方案：</p><p>① 双备或者多备模式 BACKUP 通过 priority 权重来区分谁的优先级更高</p><p>② 单播(定向广播)的方式 (一些特定环境禁用了组播方式)</p><p>③ 时间不同步 服务器时间校时</p></blockquote><h3 class="anchor anchorWithStickyNavbar_y2LR" id="1非抢占模式">1、非抢占模式<a class="hash-link" href="#1非抢占模式" title="Direct link to heading">​</a></h3><p><strong>①nopreempt</strong></p><p>在主备服务器的配置文件，vrrp_instance 段中</p><p><strong>② 设置 state 工作模式为 BACKUP</strong>
两个 keepalived 节点都启动后，默认都是 BACKUP 状态，双方在发送组播信息后，会根据优先级来选举一个 MASTER 出来。由于两者都配置了 nopreempt，所以 MASTER 从故障中恢复后，不会抢占 vip。这样会避免 VIP 切换可能造成的服务延迟。</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="2单播模式">2、单播模式<a class="hash-link" href="#2单播模式" title="Direct link to heading">​</a></h3><p>一些特定环境下不允许发送组播，造成备服务器无法收到 vrrp 包，可能会造成脑裂现象。可以通过单播的方式解决。</p><p><strong>单播示例配置：</strong>注意此语法在 keepalived1.2.11 版本以上支持</p><blockquote><p>unicast_src_ip 192.168.1.21##（本地 IP 地址）</p><p>unicast_peer {</p><p>​ 192.168.1.22##（对端 IP 地址）此地址一定不能忘记</p><p>}</p></blockquote><p><strong>主服务器 server01 配置</strong></p><div class="codeBlockContainer_J+bg language-shell theme-code-block"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">#在vrrp_instace段中加入</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">#本地IP</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">unicast_src_ip </span><span class="token number">192.168</span><span class="token plain">.17.102</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">unicast_peer </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">#对象IP  发送vrrp包给备服务器</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token number">192.168</span><span class="token plain">.17.101</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><strong>备服务器 server03 配置</strong></p><div class="codeBlockContainer_J+bg language-shell theme-code-block"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">#在vrrp_instace段中加入</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">#本地IP</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">unicast_src_ip </span><span class="token number">192.168</span><span class="token plain">.17.101</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">unicast_peer </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">#对象IP  发送vrrp包给备服务器</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token number">192.168</span><span class="token plain">.17.102</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><strong>tcpdump 抓 vrrp 包的方式：</strong></p><div class="codeBlockContainer_J+bg language-shell theme-code-block"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">shell </span><span class="token operator">&gt;</span><span class="token plain"> tcpdump vrrp -n</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/aokikoko/aokikoko.github.io/blob/main/website/docs/Nginx/ha.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_mS5F" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_mt2f"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/Nginx/safe"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">[Nginx] 安全</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/Nginx/lb"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">[Nginx] 企业架构高可用负载均衡LB服务器</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#背景描述及其方案设计" class="table-of-contents__link toc-highlight">背景描述及其方案设计</a><ul><li><a href="#1业务背景描述" class="table-of-contents__link toc-highlight">1、业务背景描述</a></li><li><a href="#2模拟运维设计方案" class="table-of-contents__link toc-highlight">2、模拟运维设计方案</a></li></ul></li><li><a href="#数据库服务器迁移" class="table-of-contents__link toc-highlight">数据库服务器迁移</a><ul><li><a href="#1服务器-ip" class="table-of-contents__link toc-highlight">1、服务器 ip</a></li><li><a href="#2服务器基本配置" class="table-of-contents__link toc-highlight">2、服务器基本配置</a></li><li><a href="#3数据备份和迁移" class="table-of-contents__link toc-highlight">3、数据备份和迁移</a></li></ul></li><li><a href="#高可用服务搭建" class="table-of-contents__link toc-highlight">高可用服务搭建</a><ul><li><a href="#1ha-高可用" class="table-of-contents__link toc-highlight">1、HA 高可用</a></li><li><a href="#2keepalived-介绍" class="table-of-contents__link toc-highlight">2、keepalived 介绍</a></li><li><a href="#3keepalived-组成和原理" class="table-of-contents__link toc-highlight">3、keepalived 组成和原理</a></li><li><a href="#4安装配置启动-keepalived" class="table-of-contents__link toc-highlight">4、安装配置启动 keepalived</a></li></ul></li><li><a href="#实现服务-ha" class="table-of-contents__link toc-highlight">实现服务 HA</a><ul><li><a href="#1nginx-服务可用检测脚本" class="table-of-contents__link toc-highlight">1、Nginx 服务可用检测脚本</a></li><li><a href="#2模拟宕机实现服务切换" class="table-of-contents__link toc-highlight">2、模拟宕机实现服务切换</a></li></ul></li><li><a href="#keepalived-的配置补充" class="table-of-contents__link toc-highlight">keepalived 的配置补充</a><ul><li><a href="#1非抢占模式" class="table-of-contents__link toc-highlight">1、非抢占模式</a></li><li><a href="#2单播模式" class="table-of-contents__link toc-highlight">2、单播模式</a></li></ul></li></ul></div></div></div></div></main></div></div></div>
<script src="/assets/js/runtime~main.c2d35455.js"></script>
<script src="/assets/js/main.dd54a102.js"></script>
</body>
</html>